name: Enable Repository Features

on:
  workflow_dispatch:
    inputs:
      repos:
        description: 'Repositories to update (comma-separated or "all")'
        required: false
        default: 'all'

jobs:
  enable-features:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Enable Features for All Repositories
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          #!/bin/bash
          set -e

          # Repository list
          REPOS=(
            "forge-labs"
            "bidflow"
            "HEPHAITOS"
            "dryon"
          )

          # If specific repos provided, use those
          if [ "${{ github.event.inputs.repos }}" != "all" ]; then
            IFS=',' read -ra REPOS <<< "${{ github.event.inputs.repos }}"
          fi

          echo "ðŸš€ Enabling features for repositories..."
          echo "Repositories: ${REPOS[@]}"

          for REPO in "${REPOS[@]}"; do
            REPO=$(echo "$REPO" | xargs)  # Trim whitespace
            echo ""
            echo "ðŸ“¦ Processing: sihu-dev/$REPO"

            # Update repository settings
            echo "  âš™ï¸  Updating repository settings..."
            curl -X PATCH \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/sihu-dev/$REPO" \
              -d '{
                "has_issues": true,
                "has_projects": true,
                "has_wiki": true,
                "has_discussions": true,
                "allow_squash_merge": true,
                "allow_merge_commit": true,
                "allow_rebase_merge": true,
                "allow_auto_merge": true,
                "delete_branch_on_merge": true,
                "allow_update_branch": true,
                "squash_merge_commit_title": "PR_TITLE",
                "squash_merge_commit_message": "PR_BODY",
                "merge_commit_title": "PR_TITLE",
                "merge_commit_message": "PR_BODY"
              }' \
              -s -o /dev/null -w "HTTP Status: %{http_code}\n" || echo "  âš ï¸  Failed to update $REPO"

            echo "  âœ… $REPO settings updated"
          done

          echo ""
          echo "âœ¨ All repositories processed successfully!"
          echo ""
          echo "Enabled features:"
          echo "  âœ… Issues"
          echo "  âœ… Projects"
          echo "  âœ… Wiki"
          echo "  âœ… Discussions"
          echo "  âœ… All merge types (merge, squash, rebase)"
          echo "  âœ… Auto-merge"
          echo "  âœ… Delete branch on merge"
          echo "  âœ… Update branch before merge"

      - name: Summary
        run: |
          echo "### âœ… Repository Features Enabled" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All repository features have been enabled successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Enabled Features:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Issues" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Projects" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Wiki" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Discussions" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… All merge types" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Auto-merge" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Delete branch on merge" >> $GITHUB_STEP_SUMMARY
