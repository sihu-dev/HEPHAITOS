# Upstash Redis Setup Guide

## Step 1: Create Upstash Account (1 minute)

1. Visit: https://console.upstash.com/login
2. Sign in with GitHub OAuth
3. Click "Create Database"

## Step 2: Configure Database (2 minutes)

**Settings**:
- **Name**: hephaitos-backtest-queue
- **Region**: Seoul (ap-northeast-2) ← **중요: 서울 선택**
- **Type**: Regional (Edge는 비싸고 불필요)
- **Eviction**: noeviction (데이터 손실 방지)
- **TLS**: Enabled (보안)

Click **Create**

## Step 3: Get Connection Details (1 minute)

Dashboard에서 다음 정보 복사:

```bash
# 1. UPSTASH_REDIS_URL (전체 URL)
UPSTASH_REDIS_URL=rediss://default:AbC...xyz@guided-mantis-12345.ap-northeast-2.upstash.io:6379

# 2. Individual components (자동 파싱됨)
UPSTASH_REDIS_HOST=guided-mantis-12345.ap-northeast-2.upstash.io
UPSTASH_REDIS_PORT=6379
UPSTASH_REDIS_PASSWORD=AbC...xyz
```

## Step 4: Update .env.local (30 seconds)

`.env.local` 파일에 복사한 값 붙여넣기:

```bash
# Loop 11: Backtest Queue System
UPSTASH_REDIS_URL=rediss://default:YOUR_PASSWORD@YOUR_REGION.upstash.io:6379
UPSTASH_REDIS_HOST=YOUR_REGION.upstash.io
UPSTASH_REDIS_PORT=6379
UPSTASH_REDIS_PASSWORD=YOUR_PASSWORD

# Worker Settings
WORKER_CONCURRENCY=5
WORKER_MAX_RETRIES=3
```

## Step 5: Test Connection (30 seconds)

```bash
# Node.js에서 테스트
node -e "const IORedis = require('ioredis'); const redis = new IORedis(process.env.UPSTASH_REDIS_URL); redis.ping().then(res => console.log('✅ Connected:', res)).catch(err => console.error('❌ Failed:', err))"

# 예상 출력: ✅ Connected: PONG
```

## Troubleshooting

### 연결 실패 시

1. **URL 형식 확인**: `rediss://` (TLS) vs `redis://` (non-TLS)
2. **방화벽 확인**: Upstash는 6379 포트 사용
3. **비밀번호 확인**: 특수문자 URL 인코딩 필요 시

### 무료 플랜 제한

- **Commands**: 10,000/day (백테스트 큐에 충분)
- **Storage**: 100MB (job metadata만 저장하므로 충분)
- **Concurrent Connections**: 100

초과 시: Pay-as-you-go $0.2 per 100K commands

## Next Steps

연결 성공 후:
```bash
# API Route 테스트
curl -X POST http://localhost:3000/api/backtest/queue \
  -H "Content-Type: application/json" \
  -d '{"strategyId":"test","params":{"symbol":"AAPL","startDate":"2020-01-01","endDate":"2025-12-22","initialCapital":10000}}'

# Worker 실행
pnpm worker
```

---

**작성**: Loop 11 Task 1
**소요 시간**: 총 5분
